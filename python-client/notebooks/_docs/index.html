<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>assign-uprn</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b219612533b75840cfc83d4209bc4ba8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="assign-uprn">
<meta property="og:description" content="python wrapper for assign api functions">
<meta property="og:site_name" content="assign-uprn">
<meta name="twitter:title" content="assign-uprn">
<meta name="twitter:description" content="python wrapper for assign api functions">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">assign-uprn</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./index.html">assign-uprn</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">assign-uprn</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_api_calls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">api calls</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_api_calls_tests.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">api calls tests</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about" id="toc-about" class="nav-link active" data-scroll-target="#about">About</a></li>
  <li><a href="#usage" id="toc-usage" class="nav-link" data-scroll-target="#usage">Usage</a>
  <ul class="collapse">
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  </ul></li>
  <li><a href="#dependencies" id="toc-dependencies" class="nav-link" data-scroll-target="#dependencies">Dependencies</a>
  <ul class="collapse">
  <li><a href="#api-access" id="toc-api-access" class="nav-link" data-scroll-target="#api-access">API Access</a></li>
  <li><a href="#license-to-use-addressbase-premium" id="toc-license-to-use-addressbase-premium" class="nav-link" data-scroll-target="#license-to-use-addressbase-premium">License to use AddressBase Premium</a></li>
  <li><a href="#api-access-and-authentication" id="toc-api-access-and-authentication" class="nav-link" data-scroll-target="#api-access-and-authentication">API access and authentication</a></li>
  <li><a href="#python-packages-used-by-this-module" id="toc-python-packages-used-by-this-module" class="nav-link" data-scroll-target="#python-packages-used-by-this-module">Python packages used by this module</a></li>
  <li><a href="#de-identification-salt" id="toc-de-identification-salt" class="nav-link" data-scroll-target="#de-identification-salt">De-identification salt</a></li>
  </ul></li>
  <li><a href="#using-the-api" id="toc-using-the-api" class="nav-link" data-scroll-target="#using-the-api">Using the API</a>
  <ul class="collapse">
  <li><a href="#single-address-check" id="toc-single-address-check" class="nav-link" data-scroll-target="#single-address-check">Single address check</a></li>
  <li><a href="#uploading-an-encrypted-salt" id="toc-uploading-an-encrypted-salt" class="nav-link" data-scroll-target="#uploading-an-encrypted-salt">Uploading an encrypted salt</a></li>
  <li><a href="#multiple-address-checking" id="toc-multiple-address-checking" class="nav-link" data-scroll-target="#multiple-address-checking">Multiple address checking</a></li>
  <li><a href="#upload" id="toc-upload" class="nav-link" data-scroll-target="#upload">Upload</a></li>
  <li><a href="#download" id="toc-download" class="nav-link" data-scroll-target="#download">Download</a></li>
  </ul></li>
  <li><a href="#developer-guide" id="toc-developer-guide" class="nav-link" data-scroll-target="#developer-guide">Developer Guide</a>
  <ul class="collapse">
  <li><a href="#working-on-the-assign-uprn-module" id="toc-working-on-the-assign-uprn-module" class="nav-link" data-scroll-target="#working-on-the-assign-uprn-module">Working on the assign-uprn module</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">assign-uprn</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p>python wrapper for ASSIGN API calls</p>
</blockquote>
<section id="about" class="level2">
<h2 class="anchored" data-anchor-id="about">About</h2>
<dl>
<dt>docs</dt>
<dd>
<a href="https://joeldn.srht.site/assign-uprn">https://joeldn.srht.site/assign-uprn</a>
</dd>
<dt>code</dt>
<dd>
<a href="https://git.sr.ht/~joeldn/assign-uprn">https://git.sr.ht/~joeldn/assign-uprn</a>
</dd>
<dt>license</dt>
<dd>
<a href="https://git.sr.ht/~joeldn/assign-uprn/tree/main/item/LICENSE">AGPLV3</a>
</dd>
</dl>
</section>
<section id="usage" class="level2">
<h2 class="anchored" data-anchor-id="usage">Usage</h2>
<section id="installation" class="level3">
<h3 class="anchored" data-anchor-id="installation">Installation</h3>
<p>Install from <a href="https://pypi.org/project/assign-uprn/">pypi</a></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install assign_uprn</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">Background</h3>
<section id="address-to-uprn-matching-algorithm" class="level4">
<h4 class="anchored" data-anchor-id="address-to-uprn-matching-algorithm">Address-to-UPRN matching algorithm</h4>
<blockquote class="blockquote">
<p>In partnership with researchers at Queen Mary University of London’s Clinical Effectiveness Group, Endeavour Health has developed an address-matching algorithm to link patient health records to geospatial information. Linking people to places can help researchers understand how health is impacted by social and environmental factors, like the characteristics of a household, green space or air pollution. But patient addresses are entered into GP records as free text so the same address can be written in different ways, making data linkage very difficult.</p>
</blockquote>
<blockquote class="blockquote">
<p>The algorithm, known as ASSIGN (<strong>A</strong>ddre<strong>SS</strong> Match<strong>I</strong>n<strong>G</strong> to Unique Property Reference <strong>N</strong>umbers), allocates a Unique Property Reference Number (UPRN) to patient records</p>
</blockquote>
<blockquote class="blockquote">
<p>Every property in the UK already has a UPRN. They are allocated by local authorities and made nationally available by Ordnance Survey. A UPRN gives every address a standardised format, enabling pseudonymised linkage to other sources of data.</p>
</blockquote>
<blockquote class="blockquote">
<p>ASSIGN compares addresses in freetext form with the Ordnance Survey’s “Address Base Premium” UPRN database, one element at a time, and decides whether there is a match. The algorithm mirrors human pattern recognition, so it allows for certain character swaps, spelling mistakes and abbreviations. After rigorous testing and adjustments, ASSIGN correctly matches 98.6% of patient addresses at 38,000 records per minute. It also includes patients’ past addresses, making it possible to study addresses across the life span.</p>
</blockquote>
<blockquote class="blockquote">
<p>The address matching algorithms use a human mediated best fit method to match a candidate address to one address from the set of all available ‘standard’ addresses.</p>
</blockquote>
<blockquote class="blockquote">
<p>The algorithms use human semantic pattern recognition, applying rankings of matching judgements following rules that manipulate the text, supported by a few machine based algorithms such as the Levenshtein distance algorithm.</p>
</blockquote>
<blockquote class="blockquote">
<p>The rankings, which can be considered as a set of numbers, <code>1-n</code>, could be described as a plausibility measure, as opposed to a probability measure or deterministic measure.</p>
</blockquote>
<p><a href="https://wiki.endeavourhealth.org/index.php?title=ASSIGN-_UPRN_address_match_application">docs</a> | <a href="https://github.com/endeavourhealth-discovery/ASSIGN">code</a></p>
</section>
<section id="uprn-de-identification" class="level4">
<h4 class="anchored" data-anchor-id="uprn-de-identification">UPRN de-identification</h4>
<p>ASSIGN can also de-identify UPRNs into Residential Anonymised Linkage Fields (RALFs). These are locations that are pseudo-anonymised by encrypting them using a salt, which has itself been encrypted by a research governance function and the openpseudobymiser website:</p>
<blockquote class="blockquote">
<p><a href="https://www.openpseudonymiser.org">https://www.openpseudonymiser.org</a></p>
</blockquote>
<p>Different datasets with UPRNs, such as council records and health records, can be de-identified using the same salt, and then linked anonymously for research purposes by anonymising the home UPRN of the person into a RALF.</p>
<div class="callout callout-style-default callout-note callout-titled" title="A note on re-identification">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>A note on re-identification
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>It’s worth noting that whilst de-identified data protects information about individuals, it can potentially be re-identified by association with other datasets, as explained in the following excerpt from Cory Doctorow’s blog:</p>
<blockquote class="blockquote">
<p><a href="https://pluralistic.net/2024/03/08/the-fire-of-orodruin/">https://pluralistic.net/2024/03/08/the-fire-of-orodruin/</a></p>
</blockquote>
<blockquote class="blockquote">
<p>…it is surprisingly easy to “re-identify” individuals in anonymous data-sets. To take an obvious example: we know which two dates former PM Tony Blair was given a specific treatment for a cardiac emergency, because this happened while he was in office. We also know Blair’s date of birth. Check any trove of NHS data that records a person who matches those three facts and you’ve found Tony Blair – and all the private data contained alongside those public facts is now in the public domain, forever.</p>
</blockquote>
<blockquote class="blockquote">
<p>Not everyone has Tony Blair’s reidentification hooks, but everyone has data in some kind of database, and those databases are continually being breached, leaked or intentionally released. A breach from a taxi service like Addison-Lee or Uber, or from Transport for London, will reveal the journeys that immediately preceded each prescription at each clinic or hospital in an “anonymous” NHS dataset, which can then be cross-referenced to databases of home addresses and workplaces. In an eyeblink, millions of Britons’ records of receiving treatment for STIs or cancer can be connected with named individuals – again, forever.</p>
</blockquote>
<p>Using de-identified UPRNs in datasets does not completely eliminate the risk of person-level records being re-identified. For this reason, an alternative research data management practice is now being using by organisations such as OpenSAFELY:</p>
<blockquote class="blockquote">
<p><a href="https://www.opensafely.org">https://www.opensafely.org</a></p>
</blockquote>
<p>OpenSAFELY retains identifiable records in a secure location whilst researchers prepare their analysis code on synthetic data, including the ability to produce disclosure controlled outputs. Researchers submit their code to OpenSAFELY, which runs it against real data, and the disclosure controls are checked by moderators prior to release back the researhers. This way, row-level information about individuals is protected against identification.</p>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="dependencies" class="level2">
<h2 class="anchored" data-anchor-id="dependencies">Dependencies</h2>
<section id="api-access" class="level3">
<h3 class="anchored" data-anchor-id="api-access">API Access</h3>
</section>
<section id="license-to-use-addressbase-premium" class="level3">
<h3 class="anchored" data-anchor-id="license-to-use-addressbase-premium">License to use AddressBase Premium</h3>
<p>AddressBase Premium usage is typically used by public service providers under the terms of the Public Services Geospatial Mapping Agreement (PSGA). You can check whether you are licensed to use this data with the following lookup:</p>
<blockquote class="blockquote">
<p><a href="https://www.ordnancesurvey.co.uk/customers/public-sector/psga-member-finder">https://www.ordnancesurvey.co.uk/customers/public-sector/psga-member-finder</a></p>
</blockquote>
</section>
<section id="api-access-and-authentication" class="level3">
<h3 class="anchored" data-anchor-id="api-access-and-authentication">API access and authentication</h3>
<p>Endeavour health manage access, and provide the API endpoints, usernames, and passwords that support API usage:</p>
<blockquote class="blockquote">
<p><a href="https://endeavourhealth.org">https://endeavourhealth.org</a></p>
</blockquote>
</section>
<section id="python-packages-used-by-this-module" class="level3">
<h3 class="anchored" data-anchor-id="python-packages-used-by-this-module">Python packages used by this module</h3>
<p>the following packages dependencies need to be available in the python environment used by this package</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pip install requests, used to interact with the API</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pip install python-dotenv, note that other dot env packages exist</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="working-with-python-dotenv" class="level4">
<h4 class="anchored" data-anchor-id="working-with-python-dotenv">Working with python-dotenv</h4>
<p>Create a <code>.env</code> file in the project root containing the following variables used by the package:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">ASSIGN_ENDPOINT</span><span class="op">=</span>endpoint</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="va">ASSIGN_USER</span><span class="op">=</span>username</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="va">ASSIGN_PASS</span><span class="op">=</span>password</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><code>.env</code> is explicitly excluded from version control by <code>.gitignore</code> which keeps your authentication credentials separate from the codebase.</p>
<p>The contents of <code>.env</code> will contain authentication credentials provided by endeavour health with the contents resembling the following structure:</p>
</section>
</section>
<section id="de-identification-salt" class="level3">
<h3 class="anchored" data-anchor-id="de-identification-salt">De-identification salt</h3>
<p>To obtain RALFs, your research governance function can support you to obtain a salt they have previously encrypted with the openpseudonymiser website using a salt phrase created for the research project being conducted:</p>
<blockquote class="blockquote">
<p><a href="https://www.openpseudonymiser.org">https://www.openpseudonymiser.org</a></p>
</blockquote>
<p>The salt is encrypted using a private key known only to The University of Nottingham (the maintainers of openpseudonymiser).</p>
</section>
</section>
<section id="using-the-api" class="level2">
<h2 class="anchored" data-anchor-id="using-the-api">Using the API</h2>
<section id="single-address-check" class="level3">
<h3 class="anchored" data-anchor-id="single-address-check">Single address check</h3>
<p>A single address can be sent for matching within a single HTTP request. A search for <code>10+Downing+St,Westminster,London,SW1A2AA</code> would receive the following response:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">"Address_format"</span><span class="fu">:</span><span class="st">"good"</span><span class="fu">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">"Postcode_quality"</span><span class="fu">:</span><span class="st">"good"</span><span class="fu">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">"Matched"</span><span class="fu">:</span><span class="kw">true</span><span class="fu">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">"BestMatch"</span><span class="fu">:{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"UPRN"</span><span class="fu">:</span><span class="st">"100023336956"</span><span class="fu">,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"Qualifier"</span><span class="fu">:</span><span class="st">"Property"</span><span class="fu">,</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"LogicalStatus"</span><span class="fu">:</span><span class="st">"1"</span><span class="fu">,</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"Classification"</span><span class="fu">:</span><span class="st">"RD04"</span><span class="fu">,</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"ClassTerm"</span><span class="fu">:</span><span class="st">"Terraced"</span><span class="fu">,</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"Algorithm"</span><span class="fu">:</span><span class="st">"10-match1"</span><span class="fu">,</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"ABPAddress"</span><span class="fu">:{</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>         <span class="dt">"Number"</span><span class="fu">:</span><span class="st">"10"</span><span class="fu">,</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>         <span class="dt">"Street"</span><span class="fu">:</span><span class="st">"Downing Street"</span><span class="fu">,</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>         <span class="dt">"Town"</span><span class="fu">:</span><span class="st">"City Of Westminster"</span><span class="fu">,</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>         <span class="dt">"Postcode"</span><span class="fu">:</span><span class="st">"SW1A 2AA"</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"Match_pattern"</span><span class="fu">:{</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>         <span class="dt">"Postcode"</span><span class="fu">:</span><span class="st">"equivalent"</span><span class="fu">,</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>         <span class="dt">"Street"</span><span class="fu">:</span><span class="st">"equivalent"</span><span class="fu">,</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>         <span class="dt">"Number"</span><span class="fu">:</span><span class="st">"equivalent"</span><span class="fu">,</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>         <span class="dt">"Building"</span><span class="fu">:</span><span class="st">"equivalent"</span><span class="fu">,</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>         <span class="dt">"Flat"</span><span class="fu">:</span><span class="st">"equivalent"</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>   <span class="fu">}</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="uploading-an-encrypted-salt" class="level3">
<h3 class="anchored" data-anchor-id="uploading-an-encrypted-salt">Uploading an encrypted salt</h3>
<p>If you wish to de-identify the UPRNS, please ask your data governance function to provide you with a <code>.EncryptedSalt</code> file from the openpseudonymiser website. You can then use the provided <code>upload</code> function to send this to the API.</p>
<p>From then on, addresses batch uploaded with the <code>upload</code> function will not only be UPRN matched, but a RALF will be provided too (see the <code>Example download file content</code> in this document).</p>
</section>
<section id="multiple-address-checking" class="level3">
<h3 class="anchored" data-anchor-id="multiple-address-checking">Multiple address checking</h3>
<p>Multiple addresses can be uploaded within a text file which is processed immediately after the file has been uploaded, and downloaded shortly afterwards.</p>
</section>
<section id="upload" class="level3">
<h3 class="anchored" data-anchor-id="upload">Upload</h3>
<p>The maximum number of address candidates that you can upload in a single file is <code>100,000</code>.</p>
<p>The address file to be uploaded must:</p>
<ul>
<li>have a .txt extension</li>
<li>include no headers</li>
<li>contain two columns separated by a single tab character
<ul>
<li>The first line must not contain any header information</li>
<li>The first column is a unique numeric row id</li>
<li>The second column is the address (with commas between each address line)</li>
</ul></li>
</ul>
<section id="example-upload-file-content" class="level4">
<h4 class="anchored" data-anchor-id="example-upload-file-content">Example upload file content:</h4>
<pre class="tsv"><code>1⭾10 Downing St,Westminster,London,SW1A2AA
3⭾Bridge Street,London,SW1A 2LW
4⭾221b Baker St,Marylebone,London,NW1 6XE
5⭾3 Abbey Rd,St John's Wood,London,NW8 9AY</code></pre>
</section>
</section>
<section id="download" class="level3">
<h3 class="anchored" data-anchor-id="download">Download</h3>
<p>Uploads are processed straightaway and can be downloaded by referencing the name of the upload file in the API call. The download includes data from AddressBase Premium (plus a RALF if you’ve previously uploaded a <code>.EncryptedSalt</code> file):</p>
<section id="example-download-file-content" class="level4">
<h4 class="anchored" data-anchor-id="example-download-file-content">Example download file content:</h4>
<div id="example-download-file-content" style="overflow-x: scroll">
<table class="caption-top table">
<colgroup>
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th>id</th>
<th>uprn</th>
<th>address_fmt</th>
<th>algorithm</th>
<th>classification</th>
<th>match_building</th>
<th>match_flat</th>
<th>match_number</th>
<th>match_postcode</th>
<th>match_street</th>
<th>abp_number</th>
<th>abp_postcode</th>
<th>abp_street</th>
<th>abp_town</th>
<th>qualifier</th>
<th>adr_candiddate</th>
<th>abp_building</th>
<th>latitude</th>
<th>longitude</th>
<th>point</th>
<th>x</th>
<th>y</th>
<th>ralf</th>
<th>classification_term</th>
<th>abp_flat</th>
<th>logical_status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>100023336956</td>
<td></td>
<td>10-match1</td>
<td>RD04</td>
<td>equivalent</td>
<td>equivalent</td>
<td>equivalent</td>
<td>equivalent</td>
<td>equivalent</td>
<td>10</td>
<td>SW1A 2AA</td>
<td>Downing Street</td>
<td>City Of Westminster</td>
<td>Property</td>
<td>10 Downing St,Westminster,London,SW1A2AA</td>
<td></td>
<td>51.5035410</td>
<td>-.1276700</td>
<td>51.5035410</td>
<td>530047.00</td>
<td>179951.00</td>
<td>C30921C8404087803C3687301351FF41CCB4A5E8F3691070723293C8BD654CBB</td>
<td>Terraced</td>
<td></td>
<td>1</td>
</tr>
<tr class="even">
<td>2</td>
<td>200002501505</td>
<td></td>
<td>550-match5a</td>
<td>PP</td>
<td>candidate field dropped</td>
<td>equivalent</td>
<td>equivalent</td>
<td>equivalent</td>
<td>equivalent</td>
<td></td>
<td>SW1A 2LW</td>
<td>Bridge Street</td>
<td>City Of Westminster</td>
<td>Property</td>
<td>Bridge Street,London,SW1A 2LW</td>
<td>Portcullis House</td>
<td>51.5013476</td>
<td>-.1243451</td>
<td>51.5013476</td>
<td>530284.00</td>
<td>179713.00</td>
<td>4D19E2EB66A2C12BD56B93D96CFBBE5B74525AEFC4C68329BE87B55C43EA4C36</td>
<td>Property Shell</td>
<td></td>
<td>1</td>
</tr>
<tr class="odd">
<td>3</td>
<td>100023071949</td>
<td></td>
<td>3200-match61A170</td>
<td>CR08</td>
<td>moved from Number</td>
<td>equivalent</td>
<td>moved to Building</td>
<td>equivalent</td>
<td>equivalent</td>
<td></td>
<td>NW1 6XE</td>
<td>Baker Street</td>
<td>London</td>
<td>Property</td>
<td>221b Baker St,Marylebone,London,NW1 6XE</td>
<td>221B</td>
<td>51.5237510</td>
<td>-.1585550</td>
<td>51.5237510</td>
<td>527847.00</td>
<td>182144.00</td>
<td>7727B90C7C3A744AF6FD8D5A4FEB6767B1EACBBC721B85EED6AE86EDD2B0BA9C</td>
<td>Shop / Showroom</td>
<td></td>
<td>1</td>
</tr>
<tr class="even">
<td>4</td>
<td>100023122909</td>
<td></td>
<td>40-match1</td>
<td>CR08</td>
<td>moved from Street</td>
<td>moved from Number</td>
<td>moved from Flat</td>
<td>equivalent</td>
<td>moved from Building</td>
<td>3</td>
<td>NW8 9AY</td>
<td>Abbey Road</td>
<td>City Of Westminster</td>
<td>Property</td>
<td>3 Abbey Rd,St Johns Wood,London,NW8 9AY</td>
<td></td>
<td>51.5321562</td>
<td>-.1779541</td>
<td>51.5321562</td>
<td>526478.00</td>
<td>183045.00</td>
<td>6E479D3F8DA8A548C631622EA8640E1CE9030289C5ED4458B91A4F6C4F92C799</td>
<td>Shop / Showroom</td>
<td></td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
</section>
<section id="developer-guide" class="level2">
<h2 class="anchored" data-anchor-id="developer-guide">Developer Guide</h2>
<p>This project uses <code>nbdev</code> which uses notebooks to create the package the module, tests, documentation (using quarto), and makes git versioning cleaner by removing notebook metadata prior to commits:</p>
<blockquote class="blockquote">
<p><a href="https://nbdev.fast.ai/">https://nbdev.fast.ai/</a></p>
</blockquote>
<section id="working-on-the-assign-uprn-module" class="level3">
<h3 class="anchored" data-anchor-id="working-on-the-assign-uprn-module">Working on the assign-uprn module</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install assign_uprn package as a developer</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install <span class="at">-e</span> <span class="st">'[.dev]'</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># make changes to notebooks in the nbs/ directory</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># clean the notebook metadata to make git history cleaner</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> nbdev_clean</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># compile to have changes apply to assign_uprn module, and run tests</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> nbdev_prepare</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># build the static website with quarto (https://quarto.org/)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> nbdev_docs</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># local preview of the website with quarto</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> nbdev_preview</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/joeldn\.srht\.site\/assign-uprn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>